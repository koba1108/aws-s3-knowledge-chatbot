# システムアーキテクチャ図

## 全体構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                          ユーザー                                      │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             │ ブラウザアクセス
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Frontend (Angular)                               │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  Chat Component                                                │  │
│  │  - メッセージ表示                                               │  │
│  │  - 入力フォーム                                                 │  │
│  │  - ソース表示                                                   │  │
│  └───────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  Chat Service                                                   │  │
│  │  - HTTP通信                                                     │  │
│  │  - セッション管理                                               │  │
│  └───────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             │ HTTP POST /api/chat
                             │ GET /api/health
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Backend (Go)                                    │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  HTTP Server                                                    │  │
│  │  - CORSハンドラー                                               │  │
│  │  - ルーティング                                                 │  │
│  └───────────────────────────────────────────────────────────────┘  │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │  Bedrock Client                                                 │  │
│  │  - AWS SDK v2                                                   │  │
│  │  - RetrieveAndGenerate API                                      │  │
│  └───────────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             │ AWS API Call
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    AWS Bedrock Agent Runtime                         │
│                                                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  1. ユーザーの質問を受信                                      │   │
│  │  2. Knowledge Baseからベクトル検索                            │   │
│  │  3. 関連ドキュメントを取得                                    │   │
│  │  4. コンテキストと共にLLMに送信                               │   │
│  │  5. 生成された回答を返却                                      │   │
│  └─────────────────────────────────────────────────────────────┘   │
└──────────────┬────────────────────────────┬─────────────────────────┘
               │                            │
               │                            │
               ▼                            ▼
┌──────────────────────────┐    ┌─────────────────────────────┐
│ Bedrock Knowledge Base   │    │  Claude 3 Sonnet (LLM)      │
│                          │    │                             │
│  - 埋め込みモデル        │    │  - 自然言語生成             │
│    (Titan Embed v1)      │    │  - コンテキスト理解         │
│  - データソース管理      │    │  - 回答生成                 │
└──────────┬───────────────┘    └─────────────────────────────┘
           │
           │
           ▼
┌──────────────────────────────────────────────┐
│     OpenSearch Serverless                    │
│                                              │
│  ┌────────────────────────────────────────┐ │
│  │  Vector Index                          │ │
│  │  - ドキュメントのベクトル表現          │ │
│  │  - セマンティック検索                  │ │
│  └────────────────────────────────────────┘ │
└──────────┬───────────────────────────────────┘
           │
           │ データ取得
           ▼
┌──────────────────────────────────────────────┐
│         Amazon S3 Bucket                     │
│                                              │
│  ┌────────────────────────────────────────┐ │
│  │  knowledge-base/                       │ │
│  │    ├── document1.pdf                   │ │
│  │    ├── document2.txt                   │ │
│  │    └── document3.docx                  │ │
│  └────────────────────────────────────────┘ │
└──────────────────────────────────────────────┘
```

## データフロー詳細

### 1. ドキュメントのインジェスト（初期セットアップ）

```
S3にアップロード → Knowledge Baseがスキャン → チャンク化 → 
埋め込み生成 → OpenSearch Serverlessに保存
```

### 2. チャットのリクエスト/レスポンス

```
ユーザー入力
    ↓
Angular Frontend (入力フォーム)
    ↓ HTTP POST
Go Backend (APIサーバー)
    ↓ AWS SDK
Bedrock Agent Runtime
    ├→ Knowledge Base (ベクトル検索)
    │     ↓
    │  OpenSearch Serverless (類似ベクトル検索)
    │     ↓
    │  S3から元のドキュメントを取得
    │     ↓
    └→ Claude 3 Sonnet (関連情報を含めたプロンプト)
          ↓
       回答生成
          ↓
Go Backend (レスポンス整形)
    ↓ JSON
Angular Frontend (表示)
    ↓
ユーザーに回答と参照元を表示
```

## コンポーネント間の通信

### Frontend ↔ Backend
- **プロトコル**: HTTP/HTTPS
- **フォーマット**: JSON
- **認証**: なし（開発環境）
- **CORS**: 有効

### Backend ↔ AWS
- **プロトコル**: HTTPS
- **SDK**: AWS SDK for Go v2
- **認証**: IAMロール/認証情報
- **リージョン**: 設定可能（デフォルト: us-east-1）

## セキュリティレイヤー

```
┌─────────────────────────────────────────────┐
│  IAM Roles & Policies                       │
│  ┌────────────────────────────────────────┐ │
│  │  Backend Role                          │ │
│  │  - Bedrock: Invoke権限                 │ │
│  │  - CloudWatch: Logs書き込み            │ │
│  └────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────┐ │
│  │  Knowledge Base Role                   │ │
│  │  - S3: 読み取り権限                    │ │
│  │  - OpenSearch: 書き込み/読み取り       │ │
│  └────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
┌─────────────────────────────────────────────┐
│  データ暗号化                                │
│  - S3: SSE-S3                               │
│  - OpenSearch: AWS管理キー                  │
│  - 通信: TLS 1.2+                           │
└─────────────────────────────────────────────┘
```

## デプロイメントオプション

### オプション1: ローカル開発
```
Docker Compose
├── Backend Container (Go)
└── Frontend Container (Angular + Nginx)
```

### オプション2: AWS ECS/Fargate
```
Application Load Balancer
├── ECS Service (Backend)
│   └── Fargate Tasks
└── CloudFront + S3 (Frontend)
```

### オプション3: サーバーレス
```
API Gateway → Lambda (Go) → Bedrock
CloudFront → S3 (Frontend)
```

## スケーリング戦略

### 水平スケーリング
- Backend: 複数インスタンス（ステートレス）
- Frontend: CDN経由で配信

### 垂直スケーリング
- OpenSearch: OCU自動調整
- Bedrock: 自動スケーリング

## モニタリングポイント

```
┌─────────────────────────────────────────────┐
│  CloudWatch Metrics                         │
│  - API呼び出し数                            │
│  - レスポンス時間                           │
│  - エラー率                                 │
│  - Knowledge Base クエリ数                  │
└─────────────────────────────────────────────┘
┌─────────────────────────────────────────────┐
│  CloudWatch Logs                            │
│  - Backend アプリケーションログ            │
│  - アクセスログ                             │
│  - エラーログ                               │
└─────────────────────────────────────────────┘
```

## コスト構造

主な課金要素:
1. **Bedrock**: トークン数ベース
2. **OpenSearch Serverless**: OCU時間
3. **S3**: ストレージとリクエスト
4. **データ転送**: リージョン間/インターネット

概算（小規模利用）: 月額 $10-30
